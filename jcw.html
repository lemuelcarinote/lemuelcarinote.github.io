document.addEventListener('DOMContentLoaded', function() {
  
  // Helper function to attach form handling to a specific form by ID
  function setupFormHandler(formId) {
    var form = document.getElementById(formId);
    if (!form) return;

    var emailInput = form.querySelector('input[type="email"]');
    var submitButton = form.querySelector('button[type="submit"]');
    var responseContainer = form.querySelector('.newsletter-signup-response');

    // Create response container if it does not exist
    if (!responseContainer) {
      responseContainer = document.createElement('div');
      responseContainer.className = 'newsletter-signup-response';
      form.appendChild(responseContainer);
    }

    function handleSubmit(event) {
      event.preventDefault();
      event.stopPropagation();

      var email = emailInput.value;

      // Remove any existing classes from response container
      responseContainer.classList.remove('success', 'error');

      if (email && validateEmail(email)) {      
        var d = new Date();
        var timestamp = d.toISOString();
        var opted_in_email = true;
        var unsubscribed = false;
        var email_spam_reported = false;

        // Call the Blueshift function to pass data
        if (typeof blueshift !== 'undefined') {
          blueshift.track("signed_up", {
            email: email,
            opted_in_email: opted_in_email,
            unsubscribed: unsubscribed,
            email_spam_reported: unsubscribed,
            signed_up_date_from_webforms: timestamp,
          });

          blueshift.identify({ email: email });
        }

        // Display success message
        responseContainer.textContent = 'Congrats! A 10% Off code has been sent to your email. Welcome to the community.';
        responseContainer.classList.add('success');

        // Clear the input after successful submission
        emailInput.value = '';
      } else {
        // Display error message
        responseContainer.textContent = 'Please enter a valid email address.';
        responseContainer.classList.add('error');
      }
    }

    // Add submit event listener to form
    form.addEventListener('submit', handleSubmit);
    
    // Also add click event listener to submit button for better compatibility
    submitButton.addEventListener('click', handleSubmit);

    // Clear error message when user starts typing a valid email address
    emailInput.addEventListener('input', function() {
      if (validateEmail(emailInput.value) && responseContainer.classList.contains('error')) {
        responseContainer.classList.remove('error');
        responseContainer.textContent = '';
      }
    });
  }

  // Setup handlers for each form
  setupFormHandler('newsletter-signup'); // Sidebar
  setupFormHandler('newsletter-signup-banner'); // Homepage banner
  setupFormHandler('footer-newsletter'); // Footer

});

// Function to validate email address
function validateEmail(email) {
  var re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}
