<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>CSR Voice CSAT Survey</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="icon" href="https://cld.partsimg.com/image/upload/h_200,w_200,f_auto,q_auto/carparts/logos/badge/blue/CP_BADGE_RGB_BLUE_HR.png">
<style>
    body {
        margin: 15px;
        font-family: 'Roboto', Arial, sans-serif;
    }
    
    .wrapper {
        display: block;
        margin: 0 auto;
        max-width: 620px;
    }

    .row {
        padding: 15px 0
    }

    .logo_section {
        display: block;
        margin: 0 auto;
    }

    .logo_section .logo {
        display: block;
        margin: 0 auto;
    }

    #expired_widget {
        display: none;
    }

    #expired_widget p, #form_widget p {
        line-height: 1.6;
        font-weight: 400;
        font-size: 16px;
    }

    #form_widget h3 {
        margin-top: 25px;
        margin-bottom: 10px
    }

    .rating-section {
        display: block;
        margin: 0 auto;
        text-align: center;
        max-width: 350px;
    }

    ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    li {
        padding: 4px;
        display: inline-block
    }

    label {
        display: inline-block;
        margin-bottom: 5px;
        font-weight: 700;
        line-height: 1.4;
    }

    input[type="radio"] {
        position: absolute;
        opacity: 0;
    }

    input[type="radio"] + label {
        display: inline-block;
        padding: 10px 18px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: #f7f7f7;
        cursor: pointer;
        font-size: 24px;
    }

    input[type="radio"] + label span {
        font-size: 18px;
        font-weight: 700;
        color: #333;
    }

    input[type="radio"] + label:hover {
        background-color: #eee;
    }

    input[type="radio"]:checked + label {
        background-color: #ffcd05;
        border-color: #ffcd05;
        color: #282832;
        transition: background-color 0.3s;
    }

    .label-row {
        display: flex;
        flex-wrap: wrap;
        width: 85%;
        margin: 0 auto
    }

    .label-row .col-50 {
        flex: 0 0 50%;
    }

    .label-row .col-50 span {
        font-size: 12px;
    }

    textarea {
        margin-top: 5px;
        padding: 10px;
        width: 95%;
        box-sizing: border-box;
    }

    input[type="submit"] {
        background-color: #ffcd05;
        border: none;
        color: #282832;
        padding: 12px 30px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 18px;
        cursor: pointer;
        border-radius: 4px;
        font-weight: 700;
    }

    #response {
        font-size: 14px;
        font-weight: 700;
    }

    @media (max-width: 460px) {
        .mob-no {
            display: none !important;
        }
    }
</style>
<meta name="robots" content="noindex, nofollow">
</head>
<body>

<div class="wrapper">
    <div class="logo_section" id="logo_section"></div>
    
    <div id="expired_widget">
        <p style="text-align: center">
            Thank you for your interest, but the survey is now closed. 
            <br class="mob-no">We hope to hear from you in the future!
        </p>
    </div>

    <div id="form_widget">
        <p>Thank you for contacting us regarding your purchase. We&nbsp;want&nbsp;to&nbsp;be&nbsp;sure&nbsp;that you&nbsp;were satisfied with the level of service we&nbsp;provided.</p>

        <h3>On a scale of 1 to 5,</h3>

        <form name="csat">
            <div class="row">
                <label for="satisfaction">How satisfied were you with the assistance provided by our Customer Service agent?</label>
                <div class="rating-section">
                    <ul>
                        <li><input type="radio" id="satisfaction1" name="satisfaction" value="1"><label for="satisfaction1"> 1</label></li>
                        <li><input type="radio" id="satisfaction2" name="satisfaction" value="2"><label for="satisfaction2"> 2</label></li>
                        <li><input type="radio" id="satisfaction3" name="satisfaction" value="3"><label for="satisfaction3"> 3</label></li>
                        <li><input type="radio" id="satisfaction4" name="satisfaction" value="4"><label for="satisfaction4"> 4</label></li>
                        <li><input type="radio" id="satisfaction5" name="satisfaction" value="5"><label for="satisfaction5"> 5</label></li>
                    </ul>
                    <div class="label-row">
                        <div class="col-50" style="text-align: left">
                          <span>Very dissatisfied</span>
                        </div>
                        <div class="col-50" style="text-align: right">
                          <span>Very satisfied</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <label for="audio_quality">How would you rate the audio quality of your recent call?</label>
                <div class="rating-section">
                    <ul>
                        <li><input type="radio" id="audio_quality1" name="audio_quality" value="1"><label for="audio_quality1"> 1</label></li>
                        <li><input type="radio" id="audio_quality2" name="audio_quality" value="2"><label for="audio_quality2"> 2</label></li>
                        <li><input type="radio" id="audio_quality3" name="audio_quality" value="3"><label for="audio_quality3"> 3</label></li>
                        <li><input type="radio" id="audio_quality4" name="audio_quality" value="4"><label for="audio_quality4"> 4</label></li>
                        <li><input type="radio" id="audio_quality5" name="audio_quality" value="5"><label for="audio_quality5"> 5</label></li>
                    </ul>
                    <div class="label-row">
                        <div class="col-50" style="text-align: left">
                          <span>Very poor</span>
                        </div>
                        <div class="col-50" style="text-align: right">
                          <span>Excellent</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <label for="comments">Please share additional comments or suggestions to help us improve our service:</label>
                <textarea id="comments" name="comments" rows="4"></textarea>
            </div>

            <div class="row" style="text-align: center">
                <input id="btnSubmit" type="submit" value="Submit">
                <div id="response"></div>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    'use strict';

    const slea = ["bGNhcml", "ub3RlQGN", "hcnBhcnRz", "LmNvbQ=="];
    const ukey = ["d745aa07", "b96e", "402b", "8f87", "37ec1859958e"].join('-');
    
    // DOM elements
    const form = document.forms.csat;
    const btnSubmit = document.getElementById("btnSubmit");
    const responseDiv = document.getElementById("response");
    const expiredWidget = document.getElementById("expired_widget");
    const formWidget = document.getElementById("form_widget");
    
    // URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const csid = urlParams.get('csid');

    if (!csid) {
        alert('Broken link. Please reply to the email, and our customer service team will be happy to assist you further.');
        return;
    }
    
    // Parse CSID data
    let obj;
    try {
        obj = JSON.parse(atob(csid));
    } catch (e) {
        console.error("Error parsing CSID:", e);
        alert('Invalid survey link. Please contact customer service.');
        return;
    }
    
    const {
        csr_voice_csat_link_expiry = null,
        csr_voice_csat_invite_at = null,
        email,
        firstname = '',
        lastname = '',
        agent_user_name: agent_username,
        merchant_order_id: order_id,
        domain_name: rawDomainName = '',
        server_name = '',
        disposition_text: disposition,
        sitecode = null
    } = obj;
    
    const name = `${firstname} ${lastname}`.trim();
    const domain_name = `${rawDomainName} / ${server_name}`;
    const domain = rawDomainName ? rawDomainName.toLowerCase() : null;
    const siteCode = sitecode ? sitecode.toLowerCase() : null;
    
    // Logo mapping
    const LOGOS = {
        'carparts.com': {
            src: 'https://cdn.getblueshift.com/pictures/227464/content/carpartscom.png',
            alt: 'CarParts.com',
            width: 200
        },
        'carpartswholesale': {
            src: 'https://cdn.getblueshift.com/pictures/194663/content/carpartswholesale.png',
            alt: 'CarParts.com',
            width: 180
        },
        'carpartswholesale-whi': {
            src: 'https://cdn.getblueshift.com/pictures/194663/content/carpartswholesale.png',
            alt: 'CarParts.com',
            width: 180
        },
        'carpartswholesale.ebay-ams.com': {
            src: 'https://cdn.getblueshift.com/pictures/162960/content/ebay-cpw.png',
            alt: 'CarPars Wholesale on eBay',
            width: 200
        },
        'carparts.ebay-ams.com': {
            src: 'https://cdn.getblueshift.com/pictures/162481/content/ebay-carparts.png',
            alt: 'CarParts on eBay',
            width: 200
        },
        'jcwhitney.ebay-ams.com': {
            src: 'https://cdn.getblueshift.com/pictures/162479/content/ebay-jcwhitney.png',
            alt: 'JC Whitney on eBay',
            width: 200
        },
        'returnedcarparts.ebay-ams.com': {
            src: 'https://cdn.getblueshift.com/pictures/163612/content/ebay-rcp.png',
            alt: 'Returned Car Parts',
            width: 200
        }
    };
    
    // Display logo based on domain/sitecode
    function displayLogo() {
        const logoSection = document.getElementById("logo_section");
        let logoKey = domain;
        
        if (!logoKey || !LOGOS[logoKey]) {
            logoKey = siteCode;
        }
        
        if (logoKey && LOGOS[logoKey]) {
            const logo = LOGOS[logoKey];
            logoSection.innerHTML = `
                <img class="logo" 
                     style="width:${logo.width}px; height:auto" 
                     src="${logo.src}" 
                     alt="${logo.alt}">`;
        }
    }
    
    // Get current date in Pacific Time
    function getCurrentDatePacificTime() {
        const options = {
            timeZone: 'America/Los_Angeles',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };
        
        const formatter = new Intl.DateTimeFormat('en-US', options);
        const parts = formatter.formatToParts(new Date());
        const { year, month, day, hour, minute, second } = Object.fromEntries(
            parts.map(part => [part.type, part.value])
        );
        
        return new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}-08:00`);
    }
    
    // Add days to a date
    function addDays(date, days) {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    }
    
    // Check if survey is expired (legacy)
    function isSurveyExpiredLegacy(inviteDate) {
        if (!inviteDate) return true;
        
        const currentDate = getCurrentDatePacificTime();
        const expiryDate = addDays(new Date(inviteDate), 8);
        return currentDate > expiryDate;
    }
    
    // Check if survey is expired (new)
    function isSurveyExpired(expiryDateString) {
        if (!expiryDateString) return true;
        
        try {
            const [datePart, timePart] = expiryDateString.split('T');
            const [year, month, day] = datePart.split('-');
            const [time, offset] = timePart.split(/(-|\+)/);
            const [hours, minutes, seconds] = time.split(':');
            
            // Create date with timezone offset
            const expiryDate = new Date(`${year}-${month}-${day}T${hours}:${minutes}:${seconds}${offset ? offset : ''}`);
            
            return getCurrentDatePacificTime() > expiryDate;
        } catch (e) {
            console.error("Error parsing expiry date:", e);
            return true;
        }
    }
    
    async function retriveKxTkn() {
        try {
            const uid = atob(slea.join(''));
            const response = await fetch("https://sheetlabs.com/DGMD/keys", {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Basic ${btoa(`${uid}:${ukey}`)}`
                }
            });

            if (!response.ok) return null;

            const responseData = await response.json();
            return responseData.find(item => item?.name === 'kx_csr')?.secret || null;
            
        } catch {
            return null;
        }
    }
    
    async function submitCSATForm(event) {
        event.preventDefault();
        
        const satisfaction = form.satisfaction.value;
        const audioQuality = form.audio_quality.value;
        const comments = form.comments.value;
        
        if (!satisfaction || !audioQuality) {
            responseDiv.innerHTML = "<p style='color: #cc0202'>Please answer all questions.</p>";
            return;
        }
        
        responseDiv.innerHTML = "<p>Please wait...</p>";
        btnSubmit.disabled = true;
        
        try {
            const token = await retriveKxTkn();
            if (!token) {
                throw new Error("Unable to authenticate");
            }
            
            const message = `Order Id: ${order_id}\nDomain/Server: ${domain_name}\n\nDisposition: ${disposition}\nCSR: ${agent_username}\n\nOn a scale of 1 to 5, \n\nHow satisfied were you with the assistance provided by our Customer Service agent? \n${satisfaction}\n\nHow would you rate the audio quality of your recent call? \n${audioQuality}\n\nPlease share additional comments or suggestions to help us improve our service: \n${comments}`;
            
            const data = {
                title: "CSR Voice CSAT Survey",
                email: email,
                message: message,
                agent_username: agent_username,
                order_id: order_id,
                domain_name: domain_name,
                disposition: disposition,
                satisfaction: satisfaction,
                audio: audioQuality,
                comments: comments
            };
            
            const response = await fetch('https://api.kustomerapp.com/v1/hooks/form/62ab35f54d6d983dd120afb0/6ff02ab5fceb6215898281533c8138872ad096d908bd5174545726d9f836a5b0', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json;charset=UTF-8',
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
            
            btnSubmit.value = "Submitted";
            btnSubmit.style.backgroundColor = "#f7f7f7";
            responseDiv.innerHTML = "<p>Thank you for your feedback!</p>";

            const cleanup = () => {
                try {
                    data.message = null;
                    data.email = null;
                    token = null;
                    
                    form.satisfaction.value = '';
                    form.audio_quality.value = '';
                    form.comments.value = '';
                    
                    if (window.gc) {
                        window.gc();
                    }
                } catch (e) {
                    console.warn("Cleanup error:", e);
                }
            };
            
            // Run cleanup immediately and schedule another pass
            cleanup();
            setTimeout(cleanup, 500);
            
        } catch (error) {
            console.error("Submission error:", error);
            responseDiv.innerHTML = `<p style='color: #cc0202'>Error: ${error.message || "Submission failed"}</p>`;
            btnSubmit.disabled = false;
        }
    }
    
    // Initialize
    function initSurvey() {
        displayLogo();

        console.log(csr_voice_csat_link_expiry);
        console.log(csr_voice_csat_invite_at);
        
        if (csr_voice_csat_link_expiry) {
            if (isSurveyExpired(csr_voice_csat_link_expiry)) {
                showExpired();
            } else {
                setupForm();
            }
        } else if (csr_voice_csat_invite_at) {
            if (isSurveyExpiredLegacy(csr_voice_csat_invite_at)) {
                showExpired();
            } else {
                setupForm();
            }
        } else {
            showExpired();
        }
    }
    
    function showExpired() {
        expiredWidget.style.display = 'block';
        formWidget.style.display = 'none';
    }
    
    function setupForm() {
        form.addEventListener('submit', submitCSATForm);
    }
    
    // Start the application
    document.addEventListener('DOMContentLoaded', initSurvey);
})();
</script>
</body>
</html>